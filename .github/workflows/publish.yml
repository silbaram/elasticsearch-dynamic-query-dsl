name: Publish Artifacts

on:
  push:
    tags: ["v*"] # 태그 푸시 시 Central 배포 트리거
  pull_request:
    branches: [develop]
  workflow_dispatch:
    inputs:
      target:
        description: "배포 대상 선택"
        required: true
        default: "github"
        type: choice
        options:
          - github
          - central

jobs:
  publish-github:
    if: (github.ref_type != 'tag' && (github.event_name != 'workflow_dispatch' || inputs.target == 'github'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: "21" }
      - uses: gradle/actions/setup-gradle@v3
      - run: ./gradlew publishMavenJavaPublicationToGitHubPackagesRepository
        env:
          GITHUB_ACTOR: ${{ secrets.PUBLISH_GITHUB_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.PUBLISH_GITHUB_TOKEN }}

  publish-central:
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || (github.event_name == 'workflow_dispatch' && inputs.target == 'central')
    runs-on: ubuntu-latest
    steps:
      # Git 히스토리를 모두 가져와야 브랜치 추적이 가능합니다.
      - name: Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 이 태그가 release 브랜치에 있는지 여기서 검증합니다.
      - name: Verify tag is on a release branch
        run: |
          # 현재 태그가 'origin/release/' 브랜치에 포함되어 있는지 확인
          if git branch -r --contains ${{ github.ref }} | grep -q 'origin/release/'; then
            echo "✅ Tag is on a release branch. Starting deployment."
          else
            echo "❌ Error: This tag was not found on any release/* branch. Halting deployment."
            exit 1 # release 브랜치가 아니면 여기서 워크플로우를 중단시킵니다.
          fi

      # 바로 Java 설정을 시작합니다.
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: "21" }

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Publish to Central Portal
        run: ./gradlew publish
        env:
          MAVEN_CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
          MAVEN_CENTRAL_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}
          signing.keyId: ${{ secrets.SIGNING_KEY_ID }}
          signing.password: ${{ secrets.SIGNING_PASSWORD }}
          signing.secretKey: ${{ secrets.SIGNING_KEY }}
